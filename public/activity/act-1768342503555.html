<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script data-noptimize="1" data-cfasync="false" data-wpfc-render="false">
    (function () {
        var script = document.createElement("script");
        script.async = 1;
        script.src = 'https://emrldtp.cc/NDg3NDU2.js?t=487456';
        document.head.appendChild(script);
    })();
  </script>
  <title>Activity Details | TradeTrends</title>
  <meta name="description" content="Explore activity details and find flights to the destination." />
  <meta name="theme-color" content="#0b0f14" />
  <link rel="stylesheet" href="/css/styles.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <style>
    .activity-detail {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 20px;
    }
    
    .activity-header {
      margin-bottom: 40px;
    }
    
    .activity-image {
      width: 100%;
      height: 400px;
      object-fit: cover;
      border-radius: 16px;
      margin-bottom: 24px;
    }
    
    .activity-info {
      background: rgba(255,255,255,0.05);
      padding: 32px;
      border-radius: 16px;
      margin-bottom: 40px;
    }
    
    .activity-title {
      font-size: 36px;
      margin-bottom: 16px;
      background: linear-gradient(135deg, #00d2ff 0%, #3a7bd5 100%);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .activity-location {
      font-size: 18px;
      color: rgba(255,255,255,0.7);
      margin-bottom: 8px;
    }
    
    .activity-price {
      font-size: 28px;
      font-weight: bold;
      color: #00d2ff;
      margin: 16px 0;
    }
    
    .activity-description {
      font-size: 16px;
      line-height: 1.6;
      color: rgba(255,255,255,0.8);
      margin-bottom: 24px;
    }
    
    .flight-calculator {
      background: rgba(255,255,255,0.05);
      padding: 32px;
      border-radius: 16px;
      margin-top: 40px;
    }
    
    .flight-calculator h2 {
      font-size: 28px;
      margin-bottom: 24px;
      color: #fff;
    }
    
    .calculator-form {
      display: grid;
      gap: 20px;
      margin-bottom: 24px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .form-group label {
      font-size: 14px;
      font-weight: 600;
      color: rgba(255,255,255,0.7);
    }
    
    .form-group input,
    .form-group select {
      padding: 12px 16px;
      border-radius: 8px;
      border: 2px solid rgba(0,210,255,0.3);
      background: rgba(255,255,255,0.05);
      color: #fff;
      font-size: 16px;
    }
    
    .date-filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .find-flights-btn {
      background: linear-gradient(135deg, #00d2ff 0%, #3a7bd5 100%);
      color: #fff;
      padding: 16px 32px;
      border-radius: 8px;
      border: none;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      width: 100%;
      transition: transform 0.2s;
    }
    
    .find-flights-btn:hover {
      transform: translateY(-2px);
    }
    
    .flight-results {
      display: none;
      margin-top: 32px;
      padding-top: 32px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    
    .flight-results.active {
      display: block;
    }
    
    .price-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 24px;
    }
    
    .price-card {
      background: rgba(255,255,255,0.08);
      padding: 24px;
      border-radius: 12px;
      text-align: center;
      border: 2px solid rgba(0,210,255,0.2);
    }
    
    .price-card.highlight {
      border-color: #00d2ff;
      background: rgba(0,210,255,0.1);
    }
    
    .price-label {
      font-size: 14px;
      text-transform: uppercase;
      color: rgba(255,255,255,0.6);
      margin-bottom: 8px;
    }
    
    .price-value {
      font-size: 32px;
      font-weight: bold;
      color: #00d2ff;
      margin-bottom: 8px;
    }
    
    .price-note {
      font-size: 12px;
      color: rgba(255,255,255,0.5);
    }
    
    .search-flights-link {
      display: inline-block;
      margin-top: 24px;
      padding: 12px 24px;
      background: rgba(0,210,255,0.2);
      color: #00d2ff;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
    }
    
    .search-flights-link:hover {
      background: rgba(0,210,255,0.3);
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: rgba(255,255,255,0.6);
    }
    
    .calendar-filter {
      background: rgba(255,255,255,0.05);
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 24px;
    }
    
    .calendar-filter h3 {
      font-size: 16px;
      margin-bottom: 16px;
      color: rgba(255,255,255,0.8);
    }
    
    .month-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 8px;
    }
    
    .month-btn {
      padding: 8px 12px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.2);
      color: rgba(255,255,255,0.7);
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    .month-btn:hover {
      background: rgba(0,210,255,0.2);
      border-color: #00d2ff;
    }
    
    .month-btn.active {
      background: rgba(0,210,255,0.3);
      border-color: #00d2ff;
      color: #00d2ff;
    }
    
    .airport-input-wrapper {
      position: relative;
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .airport-input-wrapper input {
      flex: 1;
    }
    
    .find-me-btn {
      padding: 12px 16px;
      background: rgba(0,210,255,0.2);
      border: 2px solid rgba(0,210,255,0.3);
      border-radius: 8px;
      color: #00d2ff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .find-me-btn:hover {
      background: rgba(0,210,255,0.3);
      border-color: #00d2ff;
    }
    
    .find-me-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .nearby-airports {
      margin-top: 12px;
      padding: 16px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .nearby-airports h4 {
      font-size: 14px;
      font-weight: 600;
      color: rgba(255,255,255,0.8);
      margin-bottom: 12px;
    }
    
    .flight-map-container {
      height: 400px;
      width: 100%;
      border-radius: 12px;
      overflow: hidden;
      margin: 24px 0;
      border: 2px solid rgba(0,210,255,0.2);
      display: none;
    }
    
    .flight-map-container.active {
      display: block;
    }
    
    .map-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .flight-distance {
      font-size: 14px;
      color: rgba(255,255,255,0.7);
      background: rgba(0,210,255,0.1);
      padding: 8px 16px;
      border-radius: 6px;
    }
    
    #flightMap {
      height: 100%;
      width: 100%;
      background: #0b0f14;
    }
    
    .airport-list {
      display: grid;
      gap: 8px;
    }
    
    .airport-option {
      padding: 10px 14px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .airport-option:hover {
      background: rgba(0,210,255,0.1);
      border-color: #00d2ff;
    }
    
    .airport-name {
      font-size: 14px;
      color: #fff;
      font-weight: 500;
    }
    
    .airport-code {
      font-size: 12px;
      color: rgba(255,255,255,0.6);
      font-family: monospace;
    }
    
    .airport-distance {
      font-size: 12px;
      color: rgba(255,255,255,0.5);
      margin-left: auto;
      padding-left: 12px;
    }
  </style>
</head>
<body>

<header class="header">
  <div class="container">
    <div class="nav">
      <a class="brand" href="/">
        <span class="logo" aria-hidden="true"></span>
        <span>TradeTrends Deals</span>
      </a>
      <nav class="navlinks" aria-label="Primary">
        <a class="pill" href="/#shop">Shop</a>
        <a class="pill" href="/#activities">Activities</a>
        <button class="pill hamburger" id="moreMenuBtn" aria-label="More options" aria-expanded="false">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
          </svg>
          More
        </button>
      </nav>
      <div class="more-menu" id="moreMenu" style="display:none;">
        <a href="/activities.html">All Activities</a>
        <a href="/flights.html">Flights</a>
        <a id="adminLink" href="/admin/" style="display:none;">Admin</a>
      </div>
    </div>
  </div>
</header>

<main class="container">
  <div class="activity-detail">
    
    <!-- Activity Header -->
    <div class="activity-header">
      <img id="activityImage" class="activity-image" src="" alt="">
      <div class="activity-info">
        <h1 id="activityTitle" class="activity-title"></h1>
        <div id="activityLocation" class="activity-location"></div>
        <div id="activityPrice" class="activity-price"></div>
        <div id="activityDescription" class="activity-description"></div>
        <a id="activityLink" class="btn" href="" target="_blank" rel="noopener noreferrer">Book This Activity</a>
      </div>
    </div>

    <!-- Flight Calculator -->
    <div class="flight-calculator">
      <h2>‚úàÔ∏è Find Flights to This Destination</h2>
      
      <div class="calculator-form">
        <div class="form-group">
          <label for="departureAirport">Departure Airport</label>
          <div class="airport-input-wrapper">
            <input 
              type="text" 
              id="departureAirport" 
              placeholder="Enter your departure city or airport code (e.g., LAX, New York)"
              value=""
            />
            <button class="find-me-btn" id="findMeBtn" title="Find airports near me">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <circle cx="12" cy="12" r="3"></circle>
              </svg>
              Find Me
            </button>
          </div>
          <div id="nearbyAirports" style="display: none;"></div>
        </div>
        
        <div class="calendar-filter">
          <h3>Select Travel Month (Optional)</h3>
          <div class="month-grid" id="monthGrid"></div>
        </div>
        
        <div class="date-filters">
          <div class="form-group">
            <label for="departureDate">Departure Date (Optional)</label>
            <input type="date" id="departureDate" />
          </div>
          
          <div class="form-group">
            <label for="returnDate">Return Date (Optional)</label>
            <input type="date" id="returnDate" />
          </div>
        </div>
        
        <button class="find-flights-btn" id="findFlightsBtn">Simulate Trip</button>
      </div>
      
      <!-- Flight Results -->
      <div class="flight-results" id="flightResults">
        <div class="map-header">
          <h3 style="margin-bottom: 0; color: #fff;">Your Flight Route</h3>
          <div class="flight-distance" id="flightDistance"></div>
        </div>
        
        <!-- Interactive Map -->
        <div class="flight-map-container" id="flightMapContainer">
          <div id="flightMap"></div>
        </div>
        
        <h3 style="margin-top: 24px; margin-bottom: 16px; color: #fff;">Estimated Flight Prices</h3>
        <div class="price-cards">
          <div class="price-card">
            <div class="price-label">Economy</div>
            <div class="price-value" id="lowPrice">$--</div>
            <div class="price-note">Budget-friendly</div>
          </div>
          <div class="price-card highlight">
            <div class="price-label">Average</div>
            <div class="price-value" id="avgPrice">$--</div>
            <div class="price-note">Most common</div>
          </div>
          <div class="price-card">
            <div class="price-label">Business</div>
            <div class="price-value" id="highPrice">$--</div>
            <div class="price-note">Premium</div>
          </div>
        </div>
        <p style="font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 12px;">
          üí° Prices calculated based on route distance, seasonality, and booking patterns
        </p>
        <a id="searchFlightsLink" class="search-flights-link" href="#" target="_blank">
          Compare Prices on Skyscanner ‚Üí
        </a>
      </div>
    </div>

  </div>
</main>

<footer class="primary">
  <div class="container">
    <p>&copy; 2026 TradeTrends. Affiliate links help support this site.</p>
    <div style="margin-top: 12px;">
      <a href="/" style="color: rgba(255,255,255,0.7); margin: 0 8px;">Home</a>
      <a href="/activities.html" style="color: rgba(255,255,255,0.7); margin: 0 8px;">All Activities</a>
      <a href="/flights.html" style="color: rgba(255,255,255,0.7); margin: 0 8px;">Flights</a>
    </div>
  </div>
</footer>

<script>
// Get activity ID from URL
const urlParams = new URLSearchParams(window.location.search);
const activityId = urlParams.get('id');

// Activity data
let activityData = null;

// Airport codes mapping for major cities
const airportCodes = {
  'Paris': 'CDG',
  'Tokyo': 'NRT',
  'New York': 'JFK',
  'Barcelona': 'BCN',
  'Dubai': 'DXB',
  'London': 'LHR',
  'Sierra Nevada Mountains, California, USA': 'FAT',
  'Gatlinburg, TN': 'TYS',
  'Miami, FL': 'MIA',
  'San Francisco, CA': 'SFO',
  'Antelope Canyon, Arizona': 'FLG',
  'Newport, KY': 'CVG',
  'Honolulu, HI': 'HNL'
};

// Comprehensive airports database with coordinates (200+ airports)
const majorAirports = [
  // Major US Hubs
  { code: 'ATL', name: 'Hartsfield-Jackson Atlanta International', city: 'Atlanta', lat: 33.6407, lon: -84.4277 },
  { code: 'LAX', name: 'Los Angeles International', city: 'Los Angeles', lat: 33.9425, lon: -118.408 },
  { code: 'ORD', name: "O'Hare International", city: 'Chicago', lat: 41.9742, lon: -87.9073 },
  { code: 'DFW', name: 'Dallas/Fort Worth International', city: 'Dallas', lat: 32.8998, lon: -97.0403 },
  { code: 'DEN', name: 'Denver International', city: 'Denver', lat: 39.8561, lon: -104.6737 },
  { code: 'JFK', name: 'John F. Kennedy International', city: 'New York', lat: 40.6413, lon: -73.7781 },
  { code: 'SFO', name: 'San Francisco International', city: 'San Francisco', lat: 37.6213, lon: -122.3790 },
  { code: 'LAS', name: 'Las Vegas Harry Reid International', city: 'Las Vegas', lat: 36.0840, lon: -115.1537 },
  { code: 'SEA', name: 'Seattle-Tacoma International', city: 'Seattle', lat: 47.4502, lon: -122.3088 },
  { code: 'MCO', name: 'Orlando International', city: 'Orlando', lat: 28.4312, lon: -81.3081 },
  { code: 'EWR', name: 'Newark Liberty International', city: 'Newark', lat: 40.6895, lon: -74.1745 },
  { code: 'MIA', name: 'Miami International', city: 'Miami', lat: 25.7959, lon: -80.2870 },
  { code: 'IAH', name: 'George Bush Intercontinental', city: 'Houston', lat: 29.9902, lon: -95.3368 },
  { code: 'PHX', name: 'Phoenix Sky Harbor International', city: 'Phoenix', lat: 33.4352, lon: -112.0101 },
  { code: 'BOS', name: 'Boston Logan International', city: 'Boston', lat: 42.3656, lon: -71.0096 },
  { code: 'MSP', name: 'Minneapolis-St Paul International', city: 'Minneapolis', lat: 44.8848, lon: -93.2223 },
  { code: 'DTW', name: 'Detroit Metropolitan Wayne County', city: 'Detroit', lat: 42.2162, lon: -83.3554 },
  { code: 'PHL', name: 'Philadelphia International', city: 'Philadelphia', lat: 39.8729, lon: -75.2437 },
  { code: 'LGA', name: 'LaGuardia Airport', city: 'New York', lat: 40.7769, lon: -73.8740 },
  { code: 'BWI', name: 'Baltimore/Washington International', city: 'Baltimore', lat: 39.1774, lon: -76.6684 },
  { code: 'SLC', name: 'Salt Lake City International', city: 'Salt Lake City', lat: 40.7899, lon: -111.9791 },
  { code: 'DCA', name: 'Ronald Reagan Washington National', city: 'Washington DC', lat: 38.8521, lon: -77.0377 },
  { code: 'IAD', name: 'Washington Dulles International', city: 'Washington DC', lat: 38.9531, lon: -77.4565 },
  { code: 'MDW', name: 'Chicago Midway International', city: 'Chicago', lat: 41.7868, lon: -87.7522 },
  { code: 'FLL', name: 'Fort Lauderdale-Hollywood International', city: 'Fort Lauderdale', lat: 26.0742, lon: -80.1506 },
  { code: 'SAN', name: 'San Diego International', city: 'San Diego', lat: 32.7338, lon: -117.1933 },
  { code: 'TPA', name: 'Tampa International', city: 'Tampa', lat: 27.9755, lon: -82.5332 },
  { code: 'PDX', name: 'Portland International', city: 'Portland', lat: 45.5898, lon: -122.5951 },
  { code: 'HNL', name: 'Daniel K. Inouye International', city: 'Honolulu', lat: 21.3187, lon: -157.9225 },
  { code: 'STL', name: 'St. Louis Lambert International', city: 'St. Louis', lat: 38.7499, lon: -90.3700 },
  
  // Additional Major US Airports
  { code: 'CLT', name: 'Charlotte Douglas International', city: 'Charlotte', lat: 35.2144, lon: -80.9473 },
  { code: 'HOU', name: 'William P. Hobby Airport', city: 'Houston', lat: 29.6454, lon: -95.2789 },
  { code: 'AUS', name: 'Austin-Bergstrom International', city: 'Austin', lat: 30.1945, lon: -97.6699 },
  { code: 'DAL', name: 'Dallas Love Field', city: 'Dallas', lat: 32.8470, lon: -96.8517 },
  { code: 'SNA', name: 'John Wayne Airport', city: 'Orange County', lat: 33.6762, lon: -117.8682 },
  { code: 'OAK', name: 'Oakland International', city: 'Oakland', lat: 37.7213, lon: -122.2208 },
  { code: 'SJC', name: 'Norman Y. Mineta San Jose International', city: 'San Jose', lat: 37.3626, lon: -121.9290 },
  { code: 'BUR', name: 'Hollywood Burbank Airport', city: 'Burbank', lat: 34.2007, lon: -118.3585 },
  { code: 'ONT', name: 'Ontario International', city: 'Ontario', lat: 34.0560, lon: -117.6012 },
  { code: 'SMF', name: 'Sacramento International', city: 'Sacramento', lat: 38.6954, lon: -121.5908 },
  { code: 'RNO', name: 'Reno-Tahoe International', city: 'Reno', lat: 39.4991, lon: -119.7681 },
  { code: 'ABQ', name: 'Albuquerque International Sunport', city: 'Albuquerque', lat: 35.0402, lon: -106.6092 },
  { code: 'BNA', name: 'Nashville International', city: 'Nashville', lat: 36.1245, lon: -86.6782 },
  { code: 'MCI', name: 'Kansas City International', city: 'Kansas City', lat: 39.2976, lon: -94.7139 },
  { code: 'IND', name: 'Indianapolis International', city: 'Indianapolis', lat: 39.7173, lon: -86.2944 },
  { code: 'CMH', name: 'John Glenn Columbus International', city: 'Columbus', lat: 39.9980, lon: -82.8919 },
  { code: 'CVG', name: 'Cincinnati/Northern Kentucky International', city: 'Cincinnati', lat: 39.0488, lon: -84.6678 },
  { code: 'CLE', name: 'Cleveland Hopkins International', city: 'Cleveland', lat: 41.4117, lon: -81.8498 },
  { code: 'PIT', name: 'Pittsburgh International', city: 'Pittsburgh', lat: 40.4915, lon: -80.2329 },
  { code: 'RDU', name: 'Raleigh-Durham International', city: 'Raleigh-Durham', lat: 35.8776, lon: -78.7875 },
  { code: 'RSW', name: 'Southwest Florida International', city: 'Fort Myers', lat: 26.5362, lon: -81.7552 },
  { code: 'PBI', name: 'Palm Beach International', city: 'West Palm Beach', lat: 26.6832, lon: -80.0956 },
  { code: 'JAX', name: 'Jacksonville International', city: 'Jacksonville', lat: 30.4941, lon: -81.6879 },
  { code: 'MEM', name: 'Memphis International', city: 'Memphis', lat: 35.0424, lon: -89.9767 },
  { code: 'MSY', name: 'Louis Armstrong New Orleans International', city: 'New Orleans', lat: 29.9934, lon: -90.2580 },
  { code: 'SAT', name: 'San Antonio International', city: 'San Antonio', lat: 29.5337, lon: -98.4698 },
  { code: 'OKC', name: 'Will Rogers World Airport', city: 'Oklahoma City', lat: 35.3931, lon: -97.6007 },
  { code: 'TUS', name: 'Tucson International', city: 'Tucson', lat: 32.1161, lon: -110.9410 },
  { code: 'ELP', name: 'El Paso International', city: 'El Paso', lat: 31.8072, lon: -106.3777 },
  { code: 'OMA', name: 'Eppley Airfield', city: 'Omaha', lat: 41.3032, lon: -95.8941 },
  { code: 'BDL', name: 'Bradley International', city: 'Hartford', lat: 41.9389, lon: -72.6832 },
  { code: 'PVD', name: 'T.F. Green Airport', city: 'Providence', lat: 41.7240, lon: -71.4282 },
  { code: 'MHT', name: 'Manchester-Boston Regional', city: 'Manchester', lat: 42.9326, lon: -71.4357 },
  { code: 'BUF', name: 'Buffalo Niagara International', city: 'Buffalo', lat: 42.9405, lon: -78.7322 },
  { code: 'ROC', name: 'Greater Rochester International', city: 'Rochester', lat: 43.1189, lon: -77.6724 },
  { code: 'ALB', name: 'Albany International', city: 'Albany', lat: 42.7483, lon: -73.8017 },
  { code: 'SYR', name: 'Syracuse Hancock International', city: 'Syracuse', lat: 43.1112, lon: -76.1063 },
  { code: 'MKE', name: 'Milwaukee Mitchell International', city: 'Milwaukee', lat: 42.9472, lon: -87.8966 },
  { code: 'DSM', name: 'Des Moines International', city: 'Des Moines', lat: 41.5340, lon: -93.6631 },
  { code: 'GRR', name: 'Gerald R. Ford International', city: 'Grand Rapids', lat: 42.8808, lon: -85.5228 },
  { code: 'BOI', name: 'Boise Airport', city: 'Boise', lat: 43.5644, lon: -116.2228 },
  { code: 'ANC', name: 'Ted Stevens Anchorage International', city: 'Anchorage', lat: 61.1744, lon: -149.9962 },
  { code: 'FAI', name: 'Fairbanks International', city: 'Fairbanks', lat: 64.8151, lon: -147.8562 },
  { code: 'OGG', name: 'Kahului Airport', city: 'Maui', lat: 20.8986, lon: -156.4305 },
  { code: 'KOA', name: 'Ellison Onizuka Kona International', city: 'Kona', lat: 19.7388, lon: -156.0456 },
  { code: 'LIH', name: 'Lihue Airport', city: 'Kauai', lat: 21.9760, lon: -159.3390 },
  
  // Regional Airports
  { code: 'SRQ', name: 'Sarasota-Bradenton International', city: 'Sarasota', lat: 27.3954, lon: -82.5544 },
  { code: 'TYS', name: 'McGhee Tyson Airport', city: 'Knoxville', lat: 35.8110, lon: -83.9940 },
  { code: 'GSO', name: 'Piedmont Triad International', city: 'Greensboro', lat: 36.0978, lon: -79.9373 },
  { code: 'GSP', name: 'Greenville-Spartanburg International', city: 'Greenville', lat: 34.8957, lon: -82.2189 },
  { code: 'CHS', name: 'Charleston International', city: 'Charleston', lat: 32.8986, lon: -80.0405 },
  { code: 'SAV', name: 'Savannah/Hilton Head International', city: 'Savannah', lat: 32.1276, lon: -81.2021 },
  { code: 'DAY', name: 'James M. Cox Dayton International', city: 'Dayton', lat: 39.9024, lon: -84.2194 },
  { code: 'TUL', name: 'Tulsa International', city: 'Tulsa', lat: 36.1984, lon: -95.8881 },
  { code: 'ICT', name: 'Wichita Dwight D. Eisenhower National', city: 'Wichita', lat: 37.6499, lon: -97.4331 },
  { code: 'LIT', name: 'Bill and Hillary Clinton National', city: 'Little Rock', lat: 34.7294, lon: -92.2243 },
  { code: 'BHM', name: 'Birmingham-Shuttlesworth International', city: 'Birmingham', lat: 33.5629, lon: -86.7535 },
  { code: 'MOB', name: 'Mobile Regional', city: 'Mobile', lat: 30.6912, lon: -88.2428 },
  { code: 'MSN', name: 'Dane County Regional', city: 'Madison', lat: 43.1399, lon: -89.3375 },
  { code: 'FSD', name: 'Sioux Falls Regional', city: 'Sioux Falls', lat: 43.5820, lon: -96.7419 },
  { code: 'FAR', name: 'Hector International', city: 'Fargo', lat: 46.9207, lon: -96.8158 },
  { code: 'BIL', name: 'Billings Logan International', city: 'Billings', lat: 45.8077, lon: -108.5428 },
  { code: 'GEG', name: 'Spokane International', city: 'Spokane', lat: 47.6199, lon: -117.5339 },
  { code: 'EUG', name: 'Eugene Airport', city: 'Eugene', lat: 44.1246, lon: -123.2119 },
  { code: 'PSP', name: 'Palm Springs International', city: 'Palm Springs', lat: 33.8297, lon: -116.5067 },
  { code: 'FAT', name: 'Fresno Yosemite International', city: 'Fresno', lat: 36.7762, lon: -119.7181 },
  { code: 'BFL', name: 'Meadows Field', city: 'Bakersfield', lat: 35.4336, lon: -119.0568 },
  { code: 'SBA', name: 'Santa Barbara Airport', city: 'Santa Barbara', lat: 34.4262, lon: -119.8403 },
  { code: 'STS', name: 'Charles M. Schulz Sonoma County', city: 'Santa Rosa', lat: 38.5089, lon: -122.8128 },
  { code: 'MRY', name: 'Monterey Regional', city: 'Monterey', lat: 36.5870, lon: -121.8429 },
  
  // Smaller Regional Airports
  { code: 'AVL', name: 'Asheville Regional', city: 'Asheville', lat: 35.4362, lon: -82.5418 },
  { code: 'CAE', name: 'Columbia Metropolitan', city: 'Columbia', lat: 33.9388, lon: -81.1195 },
  { code: 'CAK', name: 'Akron-Canton Airport', city: 'Akron', lat: 40.9161, lon: -81.4422 },
  { code: 'CID', name: 'The Eastern Iowa Airport', city: 'Cedar Rapids', lat: 41.8847, lon: -91.7108 },
  { code: 'COS', name: 'Colorado Springs Airport', city: 'Colorado Springs', lat: 38.8058, lon: -104.7003 },
  { code: 'CRP', name: 'Corpus Christi International', city: 'Corpus Christi', lat: 27.7704, lon: -97.5012 },
  { code: 'EYW', name: 'Key West International', city: 'Key West', lat: 24.5561, lon: -81.7594 },
  { code: 'FAY', name: 'Fayetteville Regional', city: 'Fayetteville', lat: 34.9912, lon: -78.8803 },
  { code: 'FNT', name: 'Bishop International', city: 'Flint', lat: 42.9654, lon: -83.7436 },
  { code: 'GJT', name: 'Grand Junction Regional', city: 'Grand Junction', lat: 39.1223, lon: -108.5267 },
  { code: 'GPT', name: 'Gulfport-Biloxi International', city: 'Gulfport', lat: 30.4073, lon: -89.0701 },
  { code: 'GRB', name: 'Green Bay Austin Straubel International', city: 'Green Bay', lat: 44.4851, lon: -88.1296 },
  { code: 'HSV', name: 'Huntsville International', city: 'Huntsville', lat: 34.6372, lon: -86.7751 },
  { code: 'ILM', name: 'Wilmington International', city: 'Wilmington', lat: 34.2706, lon: -77.9026 },
  { code: 'JAN', name: 'Jackson-Medgar Wiley Evers International', city: 'Jackson', lat: 32.3112, lon: -90.0759 },
  { code: 'LAN', name: 'Capital Region International', city: 'Lansing', lat: 42.7787, lon: -84.5874 },
  { code: 'LBB', name: 'Lubbock Preston Smith International', city: 'Lubbock', lat: 33.6636, lon: -101.8228 },
  { code: 'LEX', name: 'Blue Grass Airport', city: 'Lexington', lat: 38.0365, lon: -84.6059 },
  { code: 'LGB', name: 'Long Beach Airport', city: 'Long Beach', lat: 33.8177, lon: -118.1516 },
  { code: 'LFT', name: 'Lafayette Regional', city: 'Lafayette', lat: 30.2053, lon: -91.9876 },
  { code: 'MAF', name: 'Midland International Air and Space Port', city: 'Midland', lat: 31.9425, lon: -102.2019 },
  { code: 'MLB', name: 'Melbourne Orlando International', city: 'Melbourne', lat: 28.1028, lon: -80.6450 },
  { code: 'MLI', name: 'Quad City International', city: 'Moline', lat: 41.4485, lon: -90.5075 },
  { code: 'MYR', name: 'Myrtle Beach International', city: 'Myrtle Beach', lat: 33.6797, lon: -78.9283 },
  { code: 'OGS', name: 'Ogdensburg International', city: 'Ogdensburg', lat: 44.6819, lon: -75.4655 },
  { code: 'ORF', name: 'Norfolk International', city: 'Norfolk', lat: 36.8946, lon: -76.2012 },
  { code: 'PBG', name: 'Plattsburgh International', city: 'Plattsburgh', lat: 44.6509, lon: -73.4681 },
  { code: 'PNS', name: 'Pensacola International', city: 'Pensacola', lat: 30.4734, lon: -87.1866 },
  { code: 'PWM', name: 'Portland International Jetport', city: 'Portland', lat: 43.6462, lon: -70.3093 },
  { code: 'RIC', name: 'Richmond International', city: 'Richmond', lat: 37.5052, lon: -77.3197 },
  { code: 'RFD', name: 'Chicago Rockford International', city: 'Rockford', lat: 42.1954, lon: -89.0972 },
  { code: 'SDF', name: 'Louisville Muhammad Ali International', city: 'Louisville', lat: 38.1744, lon: -85.7360 },
  { code: 'SGF', name: 'Springfield-Branson National', city: 'Springfield', lat: 37.2457, lon: -93.3886 },
  { code: 'SHV', name: 'Shreveport Regional', city: 'Shreveport', lat: 32.4466, lon: -93.8256 },
  { code: 'SPI', name: 'Abraham Lincoln Capital', city: 'Springfield', lat: 39.8441, lon: -89.6779 },
  { code: 'TLH', name: 'Tallahassee International', city: 'Tallahassee', lat: 30.3965, lon: -84.3503 },
  { code: 'TOL', name: 'Eugene F. Kranz Toledo Express', city: 'Toledo', lat: 41.5868, lon: -83.8078 },
  { code: 'TRI', name: 'Tri-Cities Airport', city: 'Bristol', lat: 36.4752, lon: -82.4074 },
  { code: 'TVC', name: 'Cherry Capital Airport', city: 'Traverse City', lat: 44.7414, lon: -85.5822 },
  { code: 'TYR', name: 'Tyler Pounds Regional', city: 'Tyler', lat: 32.3541, lon: -95.4024 },
  { code: 'VPS', name: 'Destin-Fort Walton Beach Airport', city: 'Valparaiso', lat: 30.4832, lon: -86.5254 },
  { code: 'XNA', name: 'Northwest Arkansas National', city: 'Bentonville', lat: 36.2819, lon: -94.3068 },
  { code: 'YUM', name: 'Yuma International', city: 'Yuma', lat: 32.6566, lon: -114.6060 },
  
  // Additional West Coast & Mountain
  { code: 'BZN', name: 'Bozeman Yellowstone International', city: 'Bozeman', lat: 45.7769, lon: -111.1603 },
  { code: 'EKO', name: 'Elko Regional', city: 'Elko', lat: 40.8249, lon: -115.7917 },
  { code: 'FCA', name: 'Glacier Park International', city: 'Kalispell', lat: 48.3105, lon: -114.2559 },
  { code: 'GTF', name: 'Great Falls International', city: 'Great Falls', lat: 47.4820, lon: -111.3707 },
  { code: 'HLN', name: 'Helena Regional', city: 'Helena', lat: 46.6068, lon: -111.9828 },
  { code: 'IDA', name: 'Idaho Falls Regional', city: 'Idaho Falls', lat: 43.5146, lon: -112.0707 },
  { code: 'JAC', name: 'Jackson Hole Airport', city: 'Jackson', lat: 43.6073, lon: -110.7377 },
  { code: 'MFR', name: 'Rogue Valley International-Medford', city: 'Medford', lat: 42.3742, lon: -122.8735 },
  { code: 'MSO', name: 'Missoula International', city: 'Missoula', lat: 46.9163, lon: -114.0906 },
  { code: 'RDD', name: 'Redding Municipal', city: 'Redding', lat: 40.5090, lon: -122.2934 },
  { code: 'SUN', name: 'Friedman Memorial', city: 'Sun Valley', lat: 43.5044, lon: -114.2964 },
  { code: 'TWF', name: 'Magic Valley Regional', city: 'Twin Falls', lat: 42.4818, lon: -114.4877 },
  
  // Hawaii Additional
  { code: 'ITO', name: 'Hilo International', city: 'Hilo', lat: 19.7214, lon: -155.0485 },
  { code: 'JHM', name: 'Kapalua Airport', city: 'Lahaina', lat: 20.9629, lon: -156.6730 },
  { code: 'LNY', name: 'Lanai Airport', city: 'Lanai City', lat: 20.7856, lon: -156.9515 },
  { code: 'MKK', name: 'Molokai Airport', city: 'Kaunakakai', lat: 21.1529, lon: -157.0963 },
  
  // Alaska Additional
  { code: 'BET', name: 'Bethel Airport', city: 'Bethel', lat: 60.7798, lon: -161.8378 },
  { code: 'JNU', name: 'Juneau International', city: 'Juneau', lat: 58.3550, lon: -134.5764 },
  { code: 'KTN', name: 'Ketchikan International', city: 'Ketchikan', lat: 55.3556, lon: -131.7137 },
  { code: 'SIT', name: 'Sitka Rocky Gutierrez Airport', city: 'Sitka', lat: 57.0471, lon: -135.3616 },
  
  // US Territories
  { code: 'SJU', name: 'Luis Mu√±oz Mar√≠n International', city: 'San Juan', lat: 18.4394, lon: -66.0018 },
  { code: 'STT', name: 'Cyril E. King Airport', city: 'St. Thomas', lat: 18.3373, lon: -64.9733 },
  { code: 'STX', name: 'Henry E. Rohlsen Airport', city: 'St. Croix', lat: 17.7019, lon: -64.7986 },
  { code: 'GUM', name: 'Antonio B. Won Pat International', city: 'Guam', lat: 13.4834, lon: 144.7960 },
  
  // International Airports
  { code: 'YYZ', name: 'Toronto Pearson International', city: 'Toronto', lat: 43.6777, lon: -79.6248 },
  { code: 'YVR', name: 'Vancouver International', city: 'Vancouver', lat: 49.1947, lon: -123.1840 },
  { code: 'YUL', name: 'Montreal-Trudeau International', city: 'Montreal', lat: 45.4707, lon: -73.7408 },
  { code: 'YYC', name: 'Calgary International', city: 'Calgary', lat: 51.1225, lon: -114.0105 },
  { code: 'YEG', name: 'Edmonton International', city: 'Edmonton', lat: 53.3097, lon: -113.5800 },
  { code: 'YOW', name: 'Ottawa Macdonald-Cartier International', city: 'Ottawa', lat: 45.3225, lon: -75.6692 },
  { code: 'YHZ', name: 'Halifax Stanfield International', city: 'Halifax', lat: 44.8808, lon: -63.5086 },
  { code: 'MEX', name: 'Mexico City International', city: 'Mexico City', lat: 19.4363, lon: -99.0721 },
  { code: 'CUN', name: 'Cancun International', city: 'Cancun', lat: 21.0365, lon: -86.8771 },
  { code: 'GDL', name: 'Guadalajara International', city: 'Guadalajara', lat: 20.5218, lon: -103.3112 },
  { code: 'MTY', name: 'Monterrey International', city: 'Monterrey', lat: 25.7785, lon: -100.1069 },
  { code: 'SJD', name: 'Los Cabos International', city: 'San Jose del Cabo', lat: 23.1518, lon: -109.7211 },
  { code: 'PVR', name: 'Licenciado Gustavo D√≠az Ordaz International', city: 'Puerto Vallarta', lat: 20.6801, lon: -105.2544 },
  { code: 'LHR', name: 'London Heathrow', city: 'London', lat: 51.4700, lon: -0.4543 },
  { code: 'LGW', name: 'London Gatwick', city: 'London', lat: 51.1537, lon: -0.1821 },
  { code: 'CDG', name: 'Paris Charles de Gaulle', city: 'Paris', lat: 49.0097, lon: 2.5479 },
  { code: 'ORY', name: 'Paris Orly', city: 'Paris', lat: 48.7233, lon: 2.3794 },
  { code: 'FRA', name: 'Frankfurt Airport', city: 'Frankfurt', lat: 50.0379, lon: 8.5622 },
  { code: 'AMS', name: 'Amsterdam Schiphol', city: 'Amsterdam', lat: 52.3105, lon: 4.7683 },
  { code: 'MAD', name: 'Adolfo Su√°rez Madrid-Barajas', city: 'Madrid', lat: 40.4983, lon: -3.5676 },
  { code: 'BCN', name: 'Barcelona-El Prat', city: 'Barcelona', lat: 41.2974, lon: 2.0833 },
  { code: 'FCO', name: 'Leonardo da Vinci-Fiumicino', city: 'Rome', lat: 41.8003, lon: 12.2389 },
  { code: 'MXP', name: 'Milan Malpensa', city: 'Milan', lat: 45.6301, lon: 8.7231 },
  { code: 'MUC', name: 'Munich Airport', city: 'Munich', lat: 48.3537, lon: 11.7750 },
  { code: 'VIE', name: 'Vienna International', city: 'Vienna', lat: 48.1103, lon: 16.5697 },
  { code: 'ZRH', name: 'Zurich Airport', city: 'Zurich', lat: 47.4647, lon: 8.5492 },
  { code: 'LIS', name: 'Lisbon Portela', city: 'Lisbon', lat: 38.7813, lon: -9.1359 },
  { code: 'DXB', name: 'Dubai International', city: 'Dubai', lat: 25.2532, lon: 55.3657 },
  { code: 'DOH', name: 'Hamad International', city: 'Doha', lat: 25.2731, lon: 51.6086 },
  { code: 'NRT', name: 'Narita International', city: 'Tokyo', lat: 35.7720, lon: 140.3929 },
  { code: 'HND', name: 'Tokyo Haneda', city: 'Tokyo', lat: 35.5494, lon: 139.7798 },
  { code: 'KIX', name: 'Kansai International', city: 'Osaka', lat: 34.4273, lon: 135.2444 },
  { code: 'ICN', name: 'Incheon International', city: 'Seoul', lat: 37.4602, lon: 126.4407 },
  { code: 'PEK', name: 'Beijing Capital International', city: 'Beijing', lat: 40.0799, lon: 116.6031 },
  { code: 'PVG', name: 'Shanghai Pudong International', city: 'Shanghai', lat: 31.1443, lon: 121.8083 },
  { code: 'SIN', name: 'Singapore Changi', city: 'Singapore', lat: 1.3644, lon: 103.9915 },
  { code: 'BKK', name: 'Suvarnabhumi Airport', city: 'Bangkok', lat: 13.6900, lon: 100.7501 },
  { code: 'HKG', name: 'Hong Kong International', city: 'Hong Kong', lat: 22.3080, lon: 113.9185 },
  { code: 'SYD', name: 'Sydney Kingsford Smith', city: 'Sydney', lat: -33.9399, lon: 151.1753 },
  { code: 'MEL', name: 'Melbourne Airport', city: 'Melbourne', lat: -37.6690, lon: 144.8410 },
  { code: 'BNE', name: 'Brisbane Airport', city: 'Brisbane', lat: -27.3942, lon: 153.1218 },
  { code: 'AKL', name: 'Auckland Airport', city: 'Auckland', lat: -37.0082, lon: 174.7850 }
];

// Calculate distance between two coordinates (Haversine formula)
function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 3959; // Earth's radius in miles
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

// Find nearest airports to user's location
function findNearestAirports(userLat, userLon, count = 5) {
  return majorAirports
    .map(airport => ({
      ...airport,
      distance: calculateDistance(userLat, userLon, airport.lat, airport.lon)
    }))
    .sort((a, b) => a.distance - b.distance)
    .slice(0, count);
}

// Display nearby airports
function displayNearbyAirports(airports) {
  const container = document.getElementById('nearbyAirports');
  
  if (airports.length === 0) {
    container.style.display = 'none';
    return;
  }
  
  container.innerHTML = `
    <div class="nearby-airports">
      <h4>üìç Nearby Airports</h4>
      <div class="airport-list">
        ${airports.map(airport => `
          <div class="airport-option" data-code="${airport.code}">
            <div>
              <div class="airport-name">${airport.city} (${airport.code})</div>
              <div class="airport-code">${airport.name}</div>
            </div>
            <div class="airport-distance">${Math.round(airport.distance)} mi</div>
          </div>
        `).join('')}
      </div>
    </div>
  `;
  
  container.style.display = 'block';
  
  // Add click handlers to airport options
  container.querySelectorAll('.airport-option').forEach(option => {
    option.addEventListener('click', () => {
      const code = option.dataset.code;
      document.getElementById('departureAirport').value = code;
      container.style.display = 'none';
    });
  });
}

// Find Me button handler
document.getElementById('findMeBtn').addEventListener('click', async () => {
  const btn = document.getElementById('findMeBtn');
  const input = document.getElementById('departureAirport');
  
  // Check if geolocation is available
  if (!navigator.geolocation) {
    alert('Geolocation is not supported by your browser');
    return;
  }
  
  btn.disabled = true;
  btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg>Finding...';
  
  navigator.geolocation.getCurrentPosition(
    (position) => {
      const { latitude, longitude } = position.coords;
      const nearestAirports = findNearestAirports(latitude, longitude);
      
      if (nearestAirports.length > 0) {
        // Auto-fill with closest airport if input is empty
        if (!input.value.trim()) {
          input.value = nearestAirports[0].code;
        }
        // Always show the list
        displayNearbyAirports(nearestAirports);
      }
      
      btn.disabled = false;
      btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="3"></circle></svg>Find Me';
    },
    (error) => {
      console.error('Geolocation error:', error);
      let message = 'Unable to get your location. ';
      switch(error.code) {
        case error.PERMISSION_DENIED:
          message += 'Please enable location permissions.';
          break;
        case error.POSITION_UNAVAILABLE:
          message += 'Location information is unavailable.';
          break;
        case error.TIMEOUT:
          message += 'Location request timed out.';
          break;
      }
      alert(message);
      
      btn.disabled = false;
      btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="3"></circle></svg>Find Me';
    }
  );
});

// Show nearby airports on page load if field is blank
window.addEventListener('load', () => {
  const input = document.getElementById('departureAirport');
  
  // Auto-detect location on page load
  if (navigator.geolocation && !input.value.trim()) {
    navigator.geolocation.getCurrentPosition(
      (position) => {
        const { latitude, longitude } = position.coords;
        const nearestAirports = findNearestAirports(latitude, longitude);
        if (nearestAirports.length > 0) {
          displayNearbyAirports(nearestAirports);
        }
      },
      (error) => {
        // Silently fail on page load
        console.log('Auto-location detection skipped:', error.message);
      }
    );
  }
});

// Hide nearby airports when user starts typing
document.getElementById('departureAirport').addEventListener('input', (e) => {
  const container = document.getElementById('nearbyAirports');
  if (e.target.value.trim().length > 0) {
    container.style.display = 'none';
  }
});

// Load activity data
async function loadActivity() {
  try {
    const response = await fetch('/data/activities.json');
    const data = await response.json();
    
    const activity = data.items.find(item => item.id === activityId);
    
    if (!activity) {
      document.querySelector('.activity-detail').innerHTML = '<h2>Activity not found</h2>';
      return;
    }
    
    activityData = activity;
    
    // Populate activity details
    document.getElementById('activityTitle').textContent = activity.title;
    document.getElementById('activityLocation').textContent = `üìç ${activity.city}, ${activity.country}`;
    document.getElementById('activityPrice').textContent = activity.price;
    document.getElementById('activityDescription').textContent = activity.tagline;
    document.getElementById('activityImage').src = activity.image;
    document.getElementById('activityImage').alt = activity.title;
    document.getElementById('activityLink').href = activity.affiliate_url;
    
    // Update meta tags
    document.title = `${activity.title} | TradeTrends`;
    
  } catch (error) {
    console.error('Error loading activity:', error);
    document.querySelector('.activity-detail').innerHTML = '<h2>Error loading activity</h2>';
  }
}

// Generate month buttons for calendar filter
function generateMonthButtons() {
  const monthGrid = document.getElementById('monthGrid');
  const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  const currentMonth = new Date().getMonth();
  
  months.forEach((month, index) => {
    const btn = document.createElement('button');
    btn.className = 'month-btn';
    btn.textContent = month;
    btn.dataset.month = index;
    
    btn.addEventListener('click', () => {
      // Toggle active state
      const isActive = btn.classList.contains('active');
      document.querySelectorAll('.month-btn').forEach(b => b.classList.remove('active'));
      if (!isActive) {
        btn.classList.add('active');
        
        // Set approximate dates for the selected month
        const year = new Date().getFullYear();
        const monthIndex = parseInt(btn.dataset.month);
        const startDate = new Date(year, monthIndex, 1);
        const endDate = new Date(year, monthIndex + 1, 0);
        
        document.getElementById('departureDate').valueAsDate = startDate;
        document.getElementById('returnDate').valueAsDate = endDate;
      } else {
        // Clear dates if deselecting
        document.getElementById('departureDate').value = '';
        document.getElementById('returnDate').value = '';
      }
    });
    
    monthGrid.appendChild(btn);
  });
}

// Extract airport code from city name
function getAirportCode(cityName) {
  // Try exact match first
  if (airportCodes[cityName]) {
    return airportCodes[cityName];
  }
  
  // Try partial match
  for (const [city, code] of Object.entries(airportCodes)) {
    if (cityName.includes(city) || city.includes(cityName)) {
      return code;
    }
  }
  
  // Return city name if no code found
  return cityName.split(',')[0].trim();
}

// Calculate estimated flight prices based on distance, seasonality, and lead time
function calculateFlightPrices(originAirport, destinationAirport, departureDate) {
  // Get airport coordinates
  const origin = majorAirports.find(a => 
    a.code === originAirport.toUpperCase() || 
    a.city.toLowerCase().includes(originAirport.toLowerCase())
  );
  
  const destination = majorAirports.find(a => 
    a.code === destinationAirport.toUpperCase() || 
    a.city.toLowerCase().includes(destinationAirport.toLowerCase())
  );
  
  if (!origin || !destination) {
    // Fallback to simple calculation
    const isDomestic = activityData && activityData.country === 'USA';
    const basePrices = isDomestic 
      ? { low: 180, avg: 320, high: 650 }
      : { low: 450, avg: 850, high: 1600 };
    
    return {
      ...basePrices,
      distance: 0,
      origin: null,
      destination: null
    };
  }
  
  // Calculate distance between airports
  const distance = calculateDistance(origin.lat, origin.lon, destination.lat, destination.lon);
  
  // More accurate base price calculation by distance tiers
  let basePrice;
  
  if (distance < 300) {
    // Short-haul (under 300 miles): high per-mile cost
    basePrice = 150 + (distance * 0.50);
  } else if (distance < 800) {
    // Medium-haul (300-800 miles): moderate per-mile
    basePrice = 180 + (distance * 0.35);
  } else if (distance < 2000) {
    // Long domestic (800-2000 miles)
    basePrice = 250 + (distance * 0.25);
  } else if (distance < 4000) {
    // Long-haul (2000-4000 miles)
    basePrice = 400 + (distance * 0.18);
  } else {
    // Ultra long-haul (4000+ miles)
    basePrice = 600 + (distance * 0.15);
  }
  
  let economyPrice = basePrice;
  
  // International flight detection and surcharge
  const isInternational = 
    // Canadian airports (Y prefix) to/from non-Canadian
    (origin.code.startsWith('Y') && !destination.code.startsWith('Y')) ||
    (!origin.code.startsWith('Y') && destination.code.startsWith('Y')) ||
    // Trans-oceanic (major longitude difference)
    Math.abs(origin.lon - destination.lon) > 100 ||
    // Cross major water bodies
    (distance > 2500 && Math.abs(origin.lat - destination.lat) > 20);
  
  if (isInternational) {
    // International surcharge scales with distance
    if (distance > 4000) {
      economyPrice += 350; // Long international
    } else if (distance > 2000) {
      economyPrice += 250; // Medium international
    } else {
      economyPrice += 150; // Short international
    }
  }
  
  // Seasonality multiplier (more conservative)
  let seasonMultiplier = 1.0;
  if (departureDate) {
    const date = new Date(departureDate);
    const month = date.getMonth();
    
    // Peak seasons: June-August (summer), December (holidays)
    if (month >= 5 && month <= 7) {
      seasonMultiplier = 1.25;
    } else if (month === 11) {
      seasonMultiplier = 1.35;
    } else if (month >= 2 && month <= 4) {
      // Spring travel
      seasonMultiplier = 1.10;
    } else {
      // Off-peak: January, February, September-November
      seasonMultiplier = 0.92;
    }
    
    // Lead time factor (booking in advance gets discounts)
    const daysUntilFlight = Math.floor((date - new Date()) / (1000 * 60 * 60 * 24));
    if (daysUntilFlight < 7) {
      seasonMultiplier *= 1.35; // Last-minute booking penalty
    } else if (daysUntilFlight > 90) {
      seasonMultiplier *= 0.88; // Early bird discount
    } else if (daysUntilFlight > 45) {
      seasonMultiplier *= 0.94; // Advance booking discount
    }
  }
  
  economyPrice *= seasonMultiplier;
  
  // Add price variance for low/high estimates (more realistic range)
  const economyLow = economyPrice * 0.70;  // Budget airlines, sales
  const economyHigh = economyPrice * 1.25; // Peak times, last seats
  
  // Business class pricing (varies by route length)
  let businessMultiplier;
  if (distance > 4000) {
    businessMultiplier = 3.8; // Long-haul business is expensive
  } else if (distance > 2000) {
    businessMultiplier = 3.2;
  } else if (distance > 800) {
    businessMultiplier = 2.5;
  } else {
    businessMultiplier = 2.0; // Short-haul business not much more
  }
  
  return {
    low: Math.round(economyLow),
    avg: Math.round(economyPrice),
    high: Math.round(economyPrice * businessMultiplier),
    distance: Math.round(distance),
    origin: origin,
    destination: destination
  };
}

// Create interactive flight map
let flightMap = null;
function createFlightMap(origin, destination, distance) {
  const mapContainer = document.getElementById('flightMapContainer');
  const mapElement = document.getElementById('flightMap');
  
  // Show map container
  mapContainer.classList.add('active');
  
  // Clear existing map if any
  if (flightMap) {
    flightMap.remove();
  }
  
  // Initialize map centered between origin and destination
  const centerLat = (origin.lat + destination.lat) / 2;
  const centerLon = (origin.lon + destination.lon) / 2;
  
  flightMap = L.map('flightMap', {
    zoomControl: true,
    scrollWheelZoom: true,
    dragging: true,
    touchZoom: true
  }).setView([centerLat, centerLon], 2);
  
  // Add dark tile layer
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
    subdomains: 'abcd',
    maxZoom: 19
  }).addTo(flightMap);
  
  // Force map to recalculate its size
  setTimeout(() => {
    flightMap.invalidateSize();
  }, 100);
  
  // Custom marker icons
  const originIcon = L.divIcon({
    className: 'custom-marker',
    html: '<div style="background: #00d2ff; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(0,210,255,0.5);"></div>',
    iconSize: [20, 20],
    iconAnchor: [10, 10]
  });
  
  const destIcon = L.divIcon({
    className: 'custom-marker',
    html: '<div style="background: #ff6b6b; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(255,107,107,0.5);"></div>',
    iconSize: [20, 20],
    iconAnchor: [10, 10]
  });
  
  // Add markers
  const originMarker = L.marker([origin.lat, origin.lon], { icon: originIcon })
    .addTo(flightMap)
    .bindPopup(`<b>Departure</b><br>${origin.name}<br>${origin.city}`);
  
  const destMarker = L.marker([destination.lat, destination.lon], { icon: destIcon })
    .addTo(flightMap)
    .bindPopup(`<b>Destination</b><br>${destination.name}<br>${destination.city}`);
  
  // Draw flight path using great circle (geodesic) route
  // Use Leaflet's geodesic if available, otherwise simple line
  const flightPath = L.polyline(
    [[origin.lat, origin.lon], [destination.lat, destination.lon]], 
    {
      color: '#00d2ff',
      weight: 3,
      opacity: 0.8,
      dashArray: '10, 5',
      dashOffset: '0',
      className: 'animated-path'
    }
  ).addTo(flightMap);
  
  // Calculate and apply bounds with better settings
  const bounds = L.latLngBounds([
    [origin.lat, origin.lon],
    [destination.lat, destination.lon]
  ]);
  
  // Delay to ensure map is fully rendered before fitting bounds
  setTimeout(() => {
    flightMap.invalidateSize();
    flightMap.fitBounds(bounds, { 
      padding: [60, 60],
      maxZoom: 7,
      animate: false
    });
  }, 200);
  
  // Display distance
  document.getElementById('flightDistance').textContent = 
    `‚úàÔ∏è ${distance.toLocaleString()} miles (${Math.round(distance * 1.609).toLocaleString()} km)`;
  
  // Animate the path
  setTimeout(() => {
    const pathElement = document.querySelector('.animated-path');
    if (pathElement) {
      let offset = 0;
      setInterval(() => {
        offset += 2;
        pathElement.style.strokeDashoffset = offset;
      }, 50);
    }
  }, 100);
}

// Find flights
document.getElementById('findFlightsBtn').addEventListener('click', () => {
  const departure = document.getElementById('departureAirport').value.trim();
  const departureDate = document.getElementById('departureDate').value;
  const returnDate = document.getElementById('returnDate').value;
  
  if (!departure) {
    alert('Please enter your departure city or airport');
    return;
  }
  
  if (!activityData) {
    alert('Activity data not loaded');
    return;
  }
  
  // Get destination airport code
  const destinationCode = getAirportCode(activityData.city);
  
  // Calculate prices with improved algorithm
  const priceData = calculateFlightPrices(departure, destinationCode, departureDate);
  
  // Display results
  document.getElementById('lowPrice').textContent = `$${priceData.low}`;
  document.getElementById('avgPrice').textContent = `$${priceData.avg}`;
  document.getElementById('highPrice').textContent = `$${priceData.high}`;
  
  // Create interactive map if we have location data
  if (priceData.origin && priceData.destination && priceData.distance > 0) {
    createFlightMap(priceData.origin, priceData.destination, priceData.distance);
  }
  
  // Build Skyscanner affiliate URL
  let skyscannerUrl = 'https://www.skyscanner.com/transport/flights/';
  
  // Get airport codes for URL
  const originCode = majorAirports.find(a => 
    a.code === departure.toUpperCase() || 
    a.city.toLowerCase().includes(departure.toLowerCase())
  )?.code || departure.toUpperCase().substring(0, 3);
  
  const destCode = majorAirports.find(a => 
    a.code === destinationCode.toUpperCase() || 
    a.city.toLowerCase().includes(destinationCode.toLowerCase())
  )?.code || destinationCode.toUpperCase().substring(0, 3);
  
  // Format: origin/destination/YYMMDD/YYMMDD
  if (departureDate && returnDate) {
    const depDate = new Date(departureDate);
    const retDate = new Date(returnDate);
    const formatDate = (date) => {
      const yy = date.getFullYear().toString().slice(2);
      const mm = String(date.getMonth() + 1).padStart(2, '0');
      const dd = String(date.getDate()).padStart(2, '0');
      return yy + mm + dd;
    };
    skyscannerUrl += `${originCode.toLowerCase()}/${destCode.toLowerCase()}/${formatDate(depDate)}/${formatDate(retDate)}/?adultsv2=1&cabinclass=economy&childrenv2=&ref=home&rtn=1&preferdirects=false&outboundaltsenabled=false&inboundaltsenabled=false`;
  } else {
    // No specific dates - browse flights
    skyscannerUrl += `${originCode.toLowerCase()}/${destCode.toLowerCase()}/?adultsv2=1&cabinclass=economy&childrenv2=&ref=home&preferdirects=false&outboundaltsenabled=false&inboundaltsenabled=false`;
  }
  
  // Add tracking parameter for affiliate commission
  skyscannerUrl += '&associateid=SIM_1';
  
  document.getElementById('searchFlightsLink').href = skyscannerUrl;
  document.getElementById('flightResults').classList.add('active');
  
  // Scroll to results
  document.getElementById('flightResults').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
});

// Initialize
loadActivity();
generateMonthButtons();

// More menu toggle
const moreMenuBtn = document.getElementById('moreMenuBtn');
const moreMenu = document.getElementById('moreMenu');

if (moreMenuBtn && moreMenu) {
  moreMenuBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    const isOpen = moreMenu.style.display === 'block';
    moreMenu.style.display = isOpen ? 'none' : 'block';
    moreMenuBtn.setAttribute('aria-expanded', !isOpen);
  });

  document.addEventListener('click', () => {
    moreMenu.style.display = 'none';
    moreMenuBtn.setAttribute('aria-expanded', 'false');
  });

  moreMenu.addEventListener('click', (e) => {
    e.stopPropagation();
  });
}
</script>

</body>
</html>
